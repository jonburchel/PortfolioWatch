<Window x:Class="PortfolioWatch.Views.FloatingWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:helpers="clr-namespace:PortfolioWatch.Helpers"
        xmlns:converters="clr-namespace:PortfolioWatch.Converters"
        xmlns:controls="clr-namespace:PortfolioWatch.Controls"
        mc:Ignorable="d"
        Title="PortfolioWatch" Height="140" Width="140"
        WindowStyle="None" AllowsTransparency="True" Background="Transparent"
        Topmost="True" ShowInTaskbar="False" ResizeMode="NoResize">
    
    <Window.Resources>
        <helpers:BindingProxy x:Key="Proxy" Data="{Binding}"/>
        <converters:FloatingWindowOpacityConverter x:Key="FloatingWindowOpacityConverter"/>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <converters:SparklinePositiveConverter x:Key="SparklinePositiveConverter"/>
        <converters:SparklineNegativeConverter x:Key="SparklineNegativeConverter"/>
        <converters:SparklineBaselineConverter x:Key="SparklineBaselineConverter"/>
        <converters:SparklineSimpleConverter x:Key="SparklineSimpleConverter"/>
        <converters:MultiIndexGraphConverter x:Key="MultiIndexGraphConverter"/>
        <converters:IsNegativeConverter x:Key="IsNegativeConverter"/>
    </Window.Resources>

    <Grid>
        <Border x:Name="MainBorder" AutomationProperties.AutomationId="MainBorder" Width="60" Height="60" CornerRadius="30" Background="#01000000" BorderBrush="Transparent" BorderThickness="0"
                HorizontalAlignment="Center" VerticalAlignment="Center"
                MouseEnter="Border_MouseEnter" MouseLeave="Border_MouseLeave"
                MouseLeftButtonDown="Border_MouseLeftButtonDown"
                MouseRightButtonDown="Border_MouseRightButtonDown"
                ContextMenu="{StaticResource SharedContextMenu}"
                ClipToBounds="False">
            <Border.Style>
                <Style TargetType="Border">
                    <Setter Property="Opacity" Value="{Binding WindowOpacity, Converter={StaticResource FloatingWindowOpacityConverter}}"/>
                    <Setter Property="Effect">
                        <Setter.Value>
                            <DropShadowEffect BlurRadius="10" ShadowDepth="2" Opacity="0.3"/>
                        </Setter.Value>
                    </Setter>
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding IsPinned, RelativeSource={RelativeSource AncestorType=Window}}" Value="True">
                            <Setter Property="Opacity" Value="1.0"/>
                            <Setter Property="Effect">
                                <Setter.Value>
                                    <DropShadowEffect BlurRadius="15" ShadowDepth="0" Color="#00CC6A" Opacity="0.8"/>
                                </Setter.Value>
                            </Setter>
                        </DataTrigger>
                        <Trigger Property="IsMouseOver" Value="True">
                            <Setter Property="Opacity" Value="1.0"/>
                        </Trigger>
                    </Style.Triggers>
                </Style>
            </Border.Style>
            <Grid ClipToBounds="False">
                <Image Source="/pyramid.png" Stretch="Uniform" Margin="0"/>

                <!-- Market Overview (Empty Portfolio or Portfolio Mode Disabled) -->
                <Grid ClipToBounds="False">
                    <Grid.Style>
                        <Style TargetType="Grid">
                            <Setter Property="Visibility" Value="Visible"/>
                            <Style.Triggers>
                                <!-- Hide if Portfolio Mode is ON and we HAVE data (show portfolio instead) -->
                                <MultiDataTrigger>
                                    <MultiDataTrigger.Conditions>
                                        <Condition Binding="{Binding IsPortfolioMode}" Value="True"/>
                                        <Condition Binding="{Binding HasPortfolioData}" Value="True"/>
                                    </MultiDataTrigger.Conditions>
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                </MultiDataTrigger>
                                <!-- Hide if all decorations are disabled -->
                                <MultiDataTrigger>
                                    <MultiDataTrigger.Conditions>
                                        <Condition Binding="{Binding ShowFloatingWindowIntradayPercent}" Value="False"/>
                                        <Condition Binding="{Binding ShowFloatingWindowTotalValue}" Value="False"/>
                                        <Condition Binding="{Binding ShowFloatingWindowIntradayGraph}" Value="False"/>
                                    </MultiDataTrigger.Conditions>
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                </MultiDataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Grid.Style>

                    <!-- Background Scrim -->
                    <Border Background="#55000000" CornerRadius="30" IsHitTestVisible="False"/>

                    <!-- Content -->
                    <Grid ClipToBounds="False">
                        <!-- Graphs (Constrained) -->
                        <Grid Margin="12,15,12,15" Opacity="0.7" ClipToBounds="False">
                            <!-- Dow Jones -->
                            <Path StrokeThickness="1.5" Stretch="Fill"
                                  Data="{Binding Indexes, Converter={StaticResource MultiIndexGraphConverter}, ConverterParameter=^DJI}">
                                <Path.Style>
                                    <Style TargetType="Path">
                                        <Setter Property="Stroke" Value="{DynamicResource PositiveColorBrush}"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding Indexes[0].ChangePercent, Converter={StaticResource IsNegativeConverter}}" Value="True">
                                                <Setter Property="Stroke" Value="{DynamicResource NegativeColorBrush}"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Path.Style>
                                <Path.Effect><DropShadowEffect BlurRadius="2" ShadowDepth="1" Color="Black"/></Path.Effect>
                            </Path>
                            <!-- Nasdaq -->
                            <Path StrokeThickness="1.5" Stretch="Fill"
                                  Data="{Binding Indexes, Converter={StaticResource MultiIndexGraphConverter}, ConverterParameter=^IXIC}">
                                <Path.Style>
                                    <Style TargetType="Path">
                                        <Setter Property="Stroke" Value="{DynamicResource PositiveColorBrush}"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding Indexes[1].ChangePercent, Converter={StaticResource IsNegativeConverter}}" Value="True">
                                                <Setter Property="Stroke" Value="{DynamicResource NegativeColorBrush}"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Path.Style>
                                <Path.Effect><DropShadowEffect BlurRadius="2" ShadowDepth="1" Color="Black"/></Path.Effect>
                            </Path>
                            <!-- S&P 500 -->
                            <Path StrokeThickness="1.5" Stretch="Fill"
                                  Data="{Binding Indexes, Converter={StaticResource MultiIndexGraphConverter}, ConverterParameter=^GSPC}">
                                <Path.Style>
                                    <Style TargetType="Path">
                                        <Setter Property="Stroke" Value="{DynamicResource PositiveColorBrush}"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding Indexes[2].ChangePercent, Converter={StaticResource IsNegativeConverter}}" Value="True">
                                                <Setter Property="Stroke" Value="{DynamicResource NegativeColorBrush}"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Path.Style>
                                <Path.Effect><DropShadowEffect BlurRadius="2" ShadowDepth="1" Color="Black"/></Path.Effect>
                            </Path>
                        </Grid>

                        <!-- Text Info (Unconstrained) -->
                        <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center" ClipToBounds="False" Margin="0,0,0,0">
                            <StackPanel.Resources>
                                <Style TargetType="controls:OutlinedTextBlock">
                                    <Setter Property="FontSize" Value="9"/>
                                    <Setter Property="FontWeight" Value="Bold"/>
                                    <Setter Property="Stroke" Value="Black"/>
                                    <Setter Property="StrokeThickness" Value="2"/>
                                    <Setter Property="HorizontalAlignment" Value="Center"/>
                                    <Setter Property="Margin" Value="0,-1,0,-1"/>
                                    <Setter Property="Effect">
                                        <Setter.Value>
                                            <DropShadowEffect BlurRadius="2" ShadowDepth="1" Color="Black" Opacity="1"/>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </StackPanel.Resources>

                            <!-- Dow -->
                            <controls:OutlinedTextBlock Text="{Binding Indexes[0].ChangePercent, StringFormat=DJI {0:F2}%}">
                                <controls:OutlinedTextBlock.Style>
                                    <Style TargetType="controls:OutlinedTextBlock" BasedOn="{StaticResource {x:Type controls:OutlinedTextBlock}}">
                                        <Setter Property="Fill" Value="{DynamicResource PositiveColorBrush}"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding Indexes[0].ChangePercent, Converter={StaticResource IsNegativeConverter}}" Value="True">
                                                <Setter Property="Fill" Value="{DynamicResource NegativeColorBrush}"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </controls:OutlinedTextBlock.Style>
                            </controls:OutlinedTextBlock>
                            <!-- Nasdaq -->
                            <controls:OutlinedTextBlock Text="{Binding Indexes[1].ChangePercent, StringFormat=IXIC {0:F2}%}">
                                <controls:OutlinedTextBlock.Style>
                                    <Style TargetType="controls:OutlinedTextBlock" BasedOn="{StaticResource {x:Type controls:OutlinedTextBlock}}">
                                        <Setter Property="Fill" Value="{DynamicResource PositiveColorBrush}"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding Indexes[1].ChangePercent, Converter={StaticResource IsNegativeConverter}}" Value="True">
                                                <Setter Property="Fill" Value="{DynamicResource NegativeColorBrush}"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </controls:OutlinedTextBlock.Style>
                            </controls:OutlinedTextBlock>
                            <!-- S&P -->
                            <controls:OutlinedTextBlock Text="{Binding Indexes[2].ChangePercent, StringFormat=INX {0:F2}%}">
                                <controls:OutlinedTextBlock.Style>
                                    <Style TargetType="controls:OutlinedTextBlock" BasedOn="{StaticResource {x:Type controls:OutlinedTextBlock}}">
                                        <Setter Property="Fill" Value="{DynamicResource PositiveColorBrush}"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding Indexes[2].ChangePercent, Converter={StaticResource IsNegativeConverter}}" Value="True">
                                                <Setter Property="Fill" Value="{DynamicResource NegativeColorBrush}"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </controls:OutlinedTextBlock.Style>
                            </controls:OutlinedTextBlock>
                        </StackPanel>
                    </Grid>
                </Grid>

                <!-- Portfolio Decorations -->
                <Grid ClipToBounds="False">
                    <Grid.Style>
                        <Style TargetType="Grid">
                            <Setter Property="Visibility" Value="Visible"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsPortfolioMode}" Value="False">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                </DataTrigger>
                                <DataTrigger Binding="{Binding HasPortfolioData}" Value="False">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                </DataTrigger>
                                <MultiDataTrigger>
                                    <MultiDataTrigger.Conditions>
                                        <Condition Binding="{Binding ShowFloatingWindowIntradayPercent}" Value="False"/>
                                        <Condition Binding="{Binding ShowFloatingWindowTotalValue}" Value="False"/>
                                        <Condition Binding="{Binding ShowFloatingWindowIntradayGraph}" Value="False"/>
                                    </MultiDataTrigger.Conditions>
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                </MultiDataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Grid.Style>
                    
                    <!-- Background Scrim for Contrast -->
                    <Border Background="#33000000" CornerRadius="30" IsHitTestVisible="False"/>

                    <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center" Margin="5,5,0,0" ClipToBounds="False">
                        <!-- Text Info -->
                        <StackPanel HorizontalAlignment="Center" Margin="0,0,0,-2" ClipToBounds="False">
                            <StackPanel.Resources>
                                <Style TargetType="TextBlock">
                                    <Setter Property="FontWeight" Value="Bold"/>
                                    <Setter Property="Effect">
                                        <Setter.Value>
                                            <DropShadowEffect BlurRadius="4" ShadowDepth="2" Color="Black" Opacity="1.0"/>
                                        </Setter.Value>
                                    </Setter>
                                    <Setter Property="TextOptions.TextRenderingMode" Value="Aliased"/>
                                    <Setter Property="TextOptions.TextFormattingMode" Value="Display"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsIntradayPortfolioUp}" Value="True">
                                            <Setter Property="Foreground" Value="{DynamicResource PositiveColorBrush}"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding IsIntradayPortfolioUp}" Value="False">
                                            <Setter Property="Foreground" Value="{DynamicResource NegativeColorBrush}"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </StackPanel.Resources>

                            <!-- Intraday % -->
                            <controls:OutlinedTextBlock Text="{Binding IntradayPortfolioChangePercent, StringFormat={}{0:P2}}" 
                                       FontSize="12" HorizontalAlignment="Center"
                                       FontWeight="Bold" Margin="0,0,0,-2"
                                       Stroke="Black" StrokeThickness="2"
                                       Visibility="{Binding ShowFloatingWindowIntradayPercent, Converter={StaticResource BooleanToVisibilityConverter}}">
                                <controls:OutlinedTextBlock.Style>
                                    <Style TargetType="controls:OutlinedTextBlock">
                                        <Setter Property="Effect">
                                            <Setter.Value>
                                                <DropShadowEffect BlurRadius="4" ShadowDepth="2" Color="Black" Opacity="1.0"/>
                                            </Setter.Value>
                                        </Setter>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsIntradayPortfolioUp}" Value="True">
                                                <Setter Property="Fill" Value="{DynamicResource PositiveColorBrush}"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding IsIntradayPortfolioUp}" Value="False">
                                                <Setter Property="Fill" Value="{DynamicResource NegativeColorBrush}"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </controls:OutlinedTextBlock.Style>
                            </controls:OutlinedTextBlock>

                            <!-- Total Value -->
                            <controls:OutlinedTextBlock Text="{Binding IntradayPortfolioValue, StringFormat={}{0:C0}}" 
                                       Stroke="Black" StrokeThickness="2" FontWeight="Bold"
                                       FontSize="9" HorizontalAlignment="Center" Margin="0,-1,0,-2" Opacity="1.0"
                                       Visibility="{Binding ShowFloatingWindowTotalValue, Converter={StaticResource BooleanToVisibilityConverter}}">
                                                                <controls:OutlinedTextBlock.Style>
                                    <Style TargetType="controls:OutlinedTextBlock">
                                        <Setter Property="Effect">
                                            <Setter.Value>
                                                <DropShadowEffect BlurRadius="4" ShadowDepth="2" Color="Black" Opacity="1.0"/>
                                            </Setter.Value>
                                        </Setter>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsIntradayPortfolioUp}" Value="True">
                                                <Setter Property="Fill" Value="{DynamicResource PositiveColorBrush}"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding IsIntradayPortfolioUp}" Value="False">
                                                <Setter Property="Fill" Value="{DynamicResource NegativeColorBrush}"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </controls:OutlinedTextBlock.Style>
                            </controls:OutlinedTextBlock>
                        </StackPanel>

                        <!-- Sparkline Graph -->
                        <Grid Height="20" Width="50" Opacity="1.0" Margin="0,2,0,0"
                              Visibility="{Binding ShowFloatingWindowIntradayGraph, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <Grid.Effect>
                                <DropShadowEffect BlurRadius="4" ShadowDepth="1" Color="Black" Opacity="1.0"/>
                            </Grid.Effect>
                            
                            <!-- Area -->
                            <Path StrokeThickness="0">
                                <Path.Style>
                                    <Style TargetType="Path">
                                        <Setter Property="Fill" Value="{DynamicResource PositiveBackgroundBrush}"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsIntradayPortfolioUp}" Value="False">
                                                <Setter Property="Fill" Value="{DynamicResource NegativeBackgroundBrush}"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Path.Style>
                                <Path.Data>
                                    <MultiBinding Converter="{StaticResource SparklineSimpleConverter}" ConverterParameter="Area">
                                        <Binding Path="IntradayPortfolioHistory" />
                                        <Binding Path="IntradayPortfolioDayProgress" />
                                        <Binding Path="IntradayPortfolioPreviousClose" />
                                        <Binding Path="IntradayPortfolioTimestamps" />
                                    </MultiBinding>
                                </Path.Data>
                            </Path>

                            <!-- Black Outline (Shadow/Contrast) -->
                            <Path Stroke="Black" StrokeThickness="3">
                                <Path.Data>
                                    <MultiBinding Converter="{StaticResource SparklineSimpleConverter}" ConverterParameter="Line">
                                        <Binding Path="IntradayPortfolioHistory" />
                                        <Binding Path="IntradayPortfolioDayProgress" />
                                        <Binding Path="IntradayPortfolioPreviousClose" />
                                        <Binding Path="IntradayPortfolioTimestamps" />
                                    </MultiBinding>
                                </Path.Data>
                            </Path>

                            <!-- Colored Line -->
                            <Path StrokeThickness="1">
                                <Path.Style>
                                    <Style TargetType="Path">
                                        <Setter Property="Stroke" Value="{DynamicResource PositiveColorBrush}"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsIntradayPortfolioUp}" Value="False">
                                                <Setter Property="Stroke" Value="{DynamicResource NegativeColorBrush}"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Path.Style>
                                <Path.Data>
                                    <MultiBinding Converter="{StaticResource SparklineSimpleConverter}" ConverterParameter="Line">
                                        <Binding Path="IntradayPortfolioHistory" />
                                        <Binding Path="IntradayPortfolioDayProgress" />
                                        <Binding Path="IntradayPortfolioPreviousClose" />
                                        <Binding Path="IntradayPortfolioTimestamps" />
                                    </MultiBinding>
                                </Path.Data>
                            </Path>
                        </Grid>
                    </StackPanel>
                </Grid>
            </Grid>
        </Border>
    </Grid>
</Window>
